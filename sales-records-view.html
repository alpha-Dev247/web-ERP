<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Records</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .card {
            background-color: #ffffff;
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            padding: 1.5rem; /* Standard padding for content cards */
        }
        .section-header {
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* font-bold */
            color: #1f2937; /* gray-900 */
            margin-bottom: 1rem;
            border-bottom: 2px solid #F89D2F; /* Orange accent line */
            padding-bottom: 0.5rem;
        }
        .detail-action-button {
            background-color: #F89D2F; /* Specific Orange for buttons */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* font-semibold */
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .detail-action-button:hover {
            background-color: #D28528; /* Darker orange on hover */
        }
        .detail-action-button.outline {
            background-color: transparent;
            color: #F89D2F;
            border: 1px solid #F89D2F;
            box-shadow: none;
        }
        .detail-action-button.outline:hover {
            background-color: #ffe7d6; /* Light orange on hover */
        }
        
        /* Form element styling */
        .form-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            font-size: 0.9rem;
            color: #374151; /* gray-700 */
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .form-field:focus {
            outline: none;
            border-color: #F89D2F; /* Orange border on focus */
            box-shadow: 0 0 0 3px rgba(248, 157, 47, 0.3); /* Orange ring on focus */
        }
        .form-label {
            display: block;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #4b5563; /* gray-600 */
            margin-bottom: 0.5rem;
        }

        /* Responsive grid for main sections */
        .sales-records-grid {
            display: grid;
            gap: 1.5rem; /* Gap between cards */
            grid-template-columns: repeat(1, minmax(0, 1fr)); /* Default to single column */
        }
        @media (min-width: 768px) { /* Medium screens */
            .sales-records-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr)); /* Two columns */
            }
        }
        @media (min-width: 1024px) { /* Large screens */
            .sales-records-grid {
                grid-template-columns: repeat(4, minmax(0, 1fr)); /* Four columns */
            }
        }
        /* Specific column spans for larger sections */
        .col-span-2 {
            grid-column: span 2 / span 2;
        }
        @media (min-width: 1024px) {
            .lg\:col-span-2 {
                grid-column: span 2 / span 2;
            }
            .lg\:col-span-1 {
                grid-column: span 1 / span 1;
            }
            .lg\:col-start-3 {
                grid-column-start: 3;
            }
            .lg\:row-start-1 {
                grid-row-start: 1;
            }
        }

        /* Course section specific styling */
        .course-table-container {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            overflow: auto; /* Changed from hidden to auto for scrollability */
            flex-grow: 1; /* Allow it to grow in flex container */
            display: flex;
            flex-direction: column; /* Organize content vertically */
        }
        .course-table-wrapper {
            flex-grow: 1;
            overflow-y: auto; /* Enable vertical scrolling within the table wrapper */
        }
        .course-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            text-align: left;
        }
        .course-table th, .course-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap; /* Prevent wrapping in table cells */
        }
        .course-table thead {
            background-color: #f9fafb;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            position: sticky; /* Make header sticky */
            top: 0; /* Stick to the top */
            z-index: 1; /* Ensure it stays above scrolling content */
        }
        .course-table tbody tr:last-child td {
            border-bottom: none;
        }
        .course-table tbody tr:hover {
            background-color: #f3f4f6;
        }

        /* Message Box for notifications */
        .message-box {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            color: white;
            z-index: 1000;
            display: none; /* Hidden by default */
        }
        .message-box.info { background-color: #3b82f6; } /* blue-500 */
        .message-box.success { background-color: #22c55e; } /* green-500 */
        .message-box.error { background-color: #ef4444; } /* red-500 */
    </style>
</head>
<body class="p-8">

    <div class="container mx-auto">
        <div class="mb-6">
            <a href="Sales Administrator.html" class="detail-action-button outline">
                <i class="fas fa-arrow-left"></i> Back to Sales Administrator
            </a>
        </div>

        <h1 class="text-3xl font-bold text-gray-800 mb-8">Sales Records</h1>

        <div class="sales-records-grid">

            <!-- Section 1: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô -->
            <div class="card lg:col-span-1">
                <h2 class="section-header">1.‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                <div class="space-y-4">
                    <div>
                        <label for="student-id-card" class="form-label">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
                        <input type="text" id="idCard" class="form-field" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô">
                        <button id="search-student-button" class="detail-action-button mt-2">
                          üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                        </button>
                      </div>
                    <div>
                        <label for="student-code" class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                        <input type="text" id="studentCode" class="form-field" placeholder="">
                    </div>
                    <div>
                        <label for="student-name" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á</label>
                        <input type="text" id="firstName" class="form-field" placeholder="" readonly>
                    </div>
                    <div>
                        <label for="student-surname" class="form-label">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                        <input type="text" id="lastName" class="form-field" placeholder="" readonly>
                    </div>
                    <div>
                        <label for="student-nickname" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                        <input type="text" id="nickname" class="form-field" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
                        <button id="save-nickname-button" class="detail-action-button mt-2">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</button>
                    </div>
                </div>
            </div>

            <!-- Section 2: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£ -->
            <div class="card lg:col-span-1">
                <h2 class="section-header">2.‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h2>
                <div class="space-y-4">
                    <div>
                        <label for="student-status" class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                        <select id="student-status" class="form-field">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                            <option value="old">‡πÄ‡∏Å‡πà‡∏≤</option>
                            <option value="new">‡πÉ‡∏´‡∏°‡πà</option>
                        </select>
                    </div>
                    <div>
                        <label for="application-type" class="form-label">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£</label>
                        <select id="application-type" class="form-field">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£</option>
                            <option value="Line">Line</option>
                            <option value="Walk in">Walk in</option>
                        </select>
                    </div>
                    <div>
                        <label for="academic-year" class="form-label">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
                        <select id="academic-year" class="form-field">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
                            <option value="2567">2567</option>
                            <option value="2568">2568</option>
                            <option value="2569">2569</option>
                            <option value="2570">2570</option>
                        </select>
                    </div>
                    <div>
                        <label for="branch" class="form-label">‡∏™‡∏≤‡∏Ç‡∏≤</label>
                        <select id="branch" class="form-field">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
                            <option value="megabangna">‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏°‡∏Å‡∏≤‡∏ö‡∏≤‡∏á‡∏ô‡∏≤</option>
                            <option value="sukhapiban3">‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏• 3</option>
                            <option value="megabangna-off-account">‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏°‡∏Å‡∏≤‡∏ö‡∏≤‡∏á‡∏ô‡∏≤ (‡∏ô‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ)</option>
                            <option value="sukhapiban3-off-account">‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏• 3 (‡∏ô‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ)</option>
                        </select>
                    </div>
                    <div>
                        <label for="application-date" class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</label>
                        <input type="date" id="application-date" class="form-field">
                    </div>
                    <div>
                        <label for="program" class="form-label">‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°</label>
                        <select id="program" class="form-field">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°</option>
                            <option value="ALC">ALC</option>
                            <option value="TCH">TCH</option>
                        </select>
                    </div>
                    <div>
                        <label for="Season" class="form-label">‡∏ã‡∏µ‡πà‡∏ã‡∏±‡πà‡∏ô</label>
                        <select id="Season" class="form-field">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏µ‡∏ã‡∏±‡πà‡∏ô</option>
                            <option value="S1">1</option>
                            <option value="S2">2</option>
                            <option value="S3">3</option>
                            <option value="S4">4</option>
                            <option value="All">‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ</option>
                        </select>
                    </div>
                    <div>
                        <label for="class" class="form-label">‡∏£‡∏∞‡∏î‡∏±‡∏ö</label>
                        <select id="class" class="form-field">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô</option>
                            <option value="p6">‡∏õ.6</option>
                            <option value="m3">‡∏°.3</option>
                            <option value="m4">‡∏°.4</option>
                            <option value="m5">‡∏°.5</option>
                            <option value="m6">‡∏°.6</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Section 3: ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£ -->
            <div class="card lg:col-span-2 lg:col-start-3 lg:row-start-1 flex flex-col">
                <h2 class="section-header">3.‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h2>
                <!-- Course selection and add area -->
                <div class="flex items-end gap-2 mb-4">
                    <div class="flex-grow">
                        <label for="course-select" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
                        <select id="course-select" class="form-field">
                            <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏ä‡∏≤...</option>
                        </select>
                    </div>
                    <button id="add-course-button" class="detail-action-button bg-orange-500 hover:bg-orange-600 px-4 py-2">
                        <i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°
                    </button>
                </div>
                
                <!-- Course table -->
                <div class="course-table-container">
                    <div class="course-table-wrapper">
                        <table class="course-table">
                            <thead>
                                <tr>
                                    <th>‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏≠‡∏£‡πå‡∏™</th>
                                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏™</th>
                                    <th>‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                                    <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                                    <th>‡∏•‡∏ö</th>
                                </tr>
                            </thead>
                            <tbody id="selected-courses-table-body">
                                <!-- Dynamically added courses will go here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Section 4: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ä‡∏≥‡∏£‡∏∞ -->
            <div class="card lg:col-span-1">
                <h2 class="section-header">4.‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ä‡∏≥‡∏£‡∏∞</h2>
                <div class="space-y-4">
                    <div>
                        <label for="promotion" class="form-label">‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô</label>
                        <input type="text" id="promotion" class="form-field" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô">
                    </div>
                    <div>
                        <label for="discount" class="form-label">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©</label>
                        <input type="text" id="discount" class="form-field" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î">
                    </div>
                    <div>
                        <label for="payment-method" class="form-label">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö</label>
                        <select id="payment-method" class="form-field">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞</option>
                            <option value="cash">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                            <option value="transfer">‡πÇ‡∏≠‡∏ô</option>
                            <option value="credit">‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</option>
                        </select>
                    </div>
                    <div>
                        <label for="notes" class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <textarea id="notes" rows="3" class="form-field" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"></textarea>
                    </div>
                </div>
            </div>

            <!-- Section 5: ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î -->
            <div class="card lg:col-span-1">
                <h2 class="section-header">5.‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</h2>
                <div class="space-y-4">
                    <div>
                        <label for="total-amount" class="form-label">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</label>
                        <input type="text" id="total-amount" class="form-field" readonly>
                    </div>
                    <div>
                        <label for="fees" class="form-label">‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°</label>
                        <input type="text" id="fees" class="form-field" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°">
                    </div>
                    <div>
                        <label for="net-amount" class="form-label">‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</label>
                        <input type="text" id="net-amount" class="form-field" readonly>
                    </div>
                </div>
            </div>
            
            <!-- Save button (placed outside the grid for full width control) -->
            <div class="mt-8 col-span-full flex justify-center">
                <button id="save-button" class="detail-action-button bg-blue-600 hover:bg-blue-700 w-full md:w-auto px-8 py-3 rounded-xl shadow-lg">
                    <i class="fas fa-save mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
            </div>

        </div>
    </div>

    <!-- Message box for notifications -->
    <div id="infoMessageBox" class="message-box"></div>
   
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const GOOGLE_SHEET_SALES_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxWtZcyQIUQNxexbxEYSrjjEb955nnhtuRiuWJ9MRb5RyH6lu_SDhddI7tiOJ2IXYGN/exec';

            // IMPORTANT: Replace with your deployed Google Apps Script Web App URL for COURSE DATA
            const GOOGLE_SHEET_COURSE_WEB_APP_URL = 'YOUR_DEPLOYED_COURSE_DATA_WEB_APP_URL_HERE'; // Example: https://script.google.com/macros/s/AKfycbz_YOUR_COURSE_ID_HERE/exec';

            

            const studentIdCardInput = document.getElementById('idCard');
            const studentCodeInput = document.getElementById('studentCode'); 
            const studentNameInput = document.getElementById('firstName');
            const studentSurnameInput = document.getElementById('lastName');
            const studentNicknameInput = document.getElementById('nickname');

            const studentStatusInput = document.getElementById('student-status');
            const applicationTypeInput = document.getElementById('application-type');
            const academicYearInput = document.getElementById('academic-year');
            const branchInput = document.getElementById('branch');
            const applicationDateInput = document.getElementById('application-date');
            const programInput = document.getElementById('program');
            const seasonInput = document.getElementById('Season'); // Corrected ID usage
            const classInput = document.getElementById('class'); // Corrected ID usage

            const promotionInput = document.getElementById('promotion');
            const discountInput = document.getElementById('discount');
            const paymentMethodInput = document.getElementById('payment-method');
            const notesInput = document.getElementById('notes');

            const courseSelect = document.getElementById('course-select');
            const addCourseButton = document.getElementById('add-course-button');
            const selectedCoursesTableBody = document.getElementById('selected-courses-table-body');
            const totalAmountInput = document.getElementById('total-amount');
            const feesInput = document.getElementById('fees');
            const netAmountInput = document.getElementById('net-amount');
            const saveButton = document.getElementById('save-button');
            const infoMessageBox = document.getElementById('infoMessageBox');

            let availableCourses = []; // Stores all fetched course data
            let selectedCourses = []; // Stores courses currently added to the table
            let originalNickname = ''; // To track if nickname was changed from database

            // Utility function to display messages
            function displayMessage(message, type = "info") {
                infoMessageBox.textContent = message;
                infoMessageBox.className = `message-box ${type}`; // Apply type class for styling
                infoMessageBox.style.display = 'block';

                setTimeout(() => {
                    infoMessageBox.style.display = 'none';
                }, 5000); // Hide after 5 seconds
            }

            // Function to fetch student details from Google Apps Script
       async function fetchStudentDetails(searchType, searchValue) {
  try {
    const url = new URL(GOOGLE_SHEET_SALES_WEB_APP_URL);
    url.searchParams.append(searchType, searchValue);
    const response = await fetch(url.toString());
    const data = await response.json();

    if (data && data['‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á']) {
      studentNameInput.value = data['‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á'] || '';
      studentCodeInput.value = data['‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'] || '';
      studentSurnameInput.value = data['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] || '';
      studentNicknameInput.value = data['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô'] || '';
      originalNickname = data['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô'] || '';
      studentNicknameInput.readOnly = false;
      displayMessage('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß!', 'success');
    } else {
      studentCodeInput.value = '';
      studentNameInput.value = '';
      studentSurnameInput.value = '';
      studentNicknameInput.value = '';
      studentNicknameInput.readOnly = false;
      displayMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á', 'info');
    }
  } catch (error) {
    console.error('Error fetching student details:', error);
    displayMessage(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${error.message}`, 'error');
  }
}

            // Function to save/update student nickname
   async function saveStudentNickname(idType, idValue, nickname) {
  if (!idValue || !nickname) {
    displayMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™ ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'error');
    return;
  }

try {
  const formData = new URLSearchParams();
  formData.append(idType, idValue);
  formData.append('nickname', nickname);
  formData.append('action', 'updateNickname');

  await fetch(GOOGLE_SHEET_SALES_WEB_APP_URL, {
    method: 'POST',
    mode: 'no-cors',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: formData.toString()
  });

  Swal.fire({
    icon: 'success',
    title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
    timer: 1500,
    showConfirmButton: false
  });

} catch (error) {
  console.error(error);
  Swal.fire({
    icon: 'error',
    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
    text: error.message
  });
}
}



            // Event listener for ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô input
            let typingTimer; // Timer identifier
            const doneTypingInterval = 500; // Time in ms (0.5 second)

            studentIdCardInput.addEventListener('input', () => {
                clearTimeout(typingTimer);
                studentCodeInput.value = ''; // Clear other ID field
                if (studentIdCardInput.value) {
                    typingTimer = setTimeout(() => {
                        fetchStudentDetails('idCard', studentIdCardInput.value);
                    }, doneTypingInterval);
                } else {
                    fetchStudentDetails('', ''); // Clear all student details if ID is empty
                }
            });

            // Event listener for ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô input
            //studentCodeInput.addEventListener('input', () => {
                clearTimeout(typingTimer);
                studentIdCardInput.value = ''; // Clear other ID field
                if (studentCodeInput.value) {
                    typingTimer = setTimeout(() => {
                        fetchStudentDetails('studentCode', studentCodeInput.value);
                    }, doneTypingInterval);
                } else {
                    fetchStudentDetails('', ''); // Clear all student details if ID is empty
                }

                // ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏¢‡∏Å
document.getElementById("save-nickname-button").addEventListener("click", async () => {
  const idCard = studentIdCardInput.value.trim();
  const studentCode = studentCodeInput.value.trim();
  const nickname = studentNicknameInput.value.trim();

  const idType = idCard ? 'idCard' : 'studentCode';
  const idValue = idCard || studentCode;

  if (!idValue || !nickname) {
    Swal.fire('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', '', 'warning');
    return;
  }

  await saveStudentNickname(idType, idValue, nickname);
});


            });


            // Function to fetch course data from Google Apps Script
            async function fetchCourseData() {
                courseSelect.innerHTML = '<option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏ä‡∏≤...</option>';
                courseSelect.disabled = true;
                addCourseButton.disabled = true;

                try {
                    const response = await fetch(GOOGLE_SHEET_COURSE_WEB_APP_URL);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();

                    if (data && data.length > 0) {
                        // Assuming first row is headers: '‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏≠‡∏£‡πå‡∏™', '‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏™', '‡∏£‡∏≤‡∏Ñ‡∏≤', '‡∏´‡∏ô‡πà‡∏ß‡∏¢'
                        availableCourses = data.map(row => ({
                            course_code: row['‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏≠‡∏£‡πå‡∏™'],
                            course_name: row['‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏™'],
                            price: parseFloat(row['‡∏£‡∏≤‡∏Ñ‡∏≤']) || 0, // Ensure price is a number
                            unit: row['‡∏´‡∏ô‡πà‡∏ß‡∏¢']
                        }));
                        populateCourseDropdown();
                        displayMessage('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    } else {
                        availableCourses = [];
                        courseSelect.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤</option>';
                        displayMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏ô Google Sheet.', 'info');
                    }
                } catch (error) {
                    console.error('Error fetching course data:', error);
                    courseSelect.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡πÑ‡∏î‡πâ</option>';
                    displayMessage(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤: ${error.message}. ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL Apps Script.`, 'error');
                } finally {
                    courseSelect.disabled = false;
                    addCourseButton.disabled = false;
                }
            }

            // Populate the course dropdown with fetched data
            function populateCourseDropdown() {
                courseSelect.innerHTML = '<option value="">--- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ ---</option>';
                availableCourses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.course_code;
                    option.textContent = `${course.course_code} - ${course.course_name} (${course.price.toLocaleString()} ${course.unit})`;
                    courseSelect.appendChild(option);
                });
            }

            // Add selected course to the table
            addCourseButton.addEventListener('click', () => {
                const selectedCourseCode = courseSelect.value;
                if (!selectedCourseCode) {
                    displayMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°', 'info');
                    return;
                }

                const courseToAdd = availableCourses.find(course => course.course_code === selectedCourseCode);

                if (courseToAdd && !selectedCourses.some(c => c.course_code === courseToAdd.course_code)) {
                    selectedCourses.push(courseToAdd);
                    renderSelectedCourses();
                    calculateTotals();
                } else if (selectedCourses.some(c => c.course_code === courseToAdd.course_code)) {
                    displayMessage('‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß', 'info');
                }
            });

            // Render selected courses in the table
            function renderSelectedCourses() {
                selectedCoursesTableBody.innerHTML = ''; // Clear existing rows
                if (selectedCourses.length === 0) {
                    const noDataRow = document.createElement('tr');
                    noDataRow.innerHTML = `<td colspan="5" class="text-center text-gray-500 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td>`;
                    selectedCoursesTableBody.appendChild(noDataRow);
                    return;
                }

                selectedCourses.forEach(course => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${course.course_code}</td>
                        <td>${course.course_name}</td>
                        <td>${course.price.toLocaleString()}</td>
                        <td>${course.unit}</td>
                        <td><button class="text-red-500 hover:text-red-700 remove-course-button" data-course-code="${course.course_code}"><i class="fas fa-trash"></i></button></td>
                    `;
                    selectedCoursesTableBody.appendChild(tr);
                });
            }

            // Remove course from table
            selectedCoursesTableBody.addEventListener('click', (event) => {
                const removeButton = event.target.closest('.remove-course-button');
                if (removeButton) {
                    const courseCodeToRemove = removeButton.dataset.courseCode;
                    selectedCourses = selectedCourses.filter(course => course.course_code !== courseCodeToRemove);
                    renderSelectedCourses();
                    calculateTotals();
                }
            });

            // Basic calculation for total amount and net amount
            function calculateTotals() {
                let sum = selectedCourses.reduce((acc, course) => acc + course.price, 0);
                totalAmountInput.value = sum.toLocaleString(); // Format with commas

                const fees = parseFloat(feesInput.value.replace(/,/g, '')) || 0;
                netAmountInput.value = (sum - fees).toLocaleString();
            }

            // Call calculation on page load and when fees input changes
            renderSelectedCourses(); // Initial render for empty state
            calculateTotals();
            feesInput.addEventListener('input', calculateTotals);

            // Save button functionality
            saveButton.addEventListener('click', async () => {
                const idCard = studentIdCardInput.value.trim();
                const studentCode = studentCodeInput.value.trim(); 
                const currentNickname = studentNicknameInput.value.trim();

                let idType = '';
                let idValue = '';

                if (idCard) {
                    idType = 'idCard';
                    idValue = idCard;
                } else if (studentCode) {
                    idType = 'studentCode';
                    idValue = studentCode;
                }

                // 1. Save/Update Nickname
                if (idValue && currentNickname !== originalNickname) {
                    await saveStudentNickname(idType, idValue, currentNickname);
                } else if (!idValue) {
                    displayMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'error');
                }

                // 2. Gather all sales record data
                const salesRecordData = {
                    "‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô": document.getElementById("idCard").value.trim(),
                    "‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô": document.getElementById("studentCode").value.trim(),
                    "‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á": document.getElementById("firstName").value.trim(),
                    "‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•": document.getElementById("lastName").value.trim(),
                    "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô": document.getElementById("nickname").value.trim(),
                    "‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô": document.getElementById("school").value.trim(),
                    "Email": document.getElementById("email").value.trim(),
                    "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà": document.getElementById("address").value.trim(),

                    "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô": document.getElementById("studentStatus").value.trim(),
                    "‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£": document.getElementById("applicationType").value.trim(),
                    "‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤": document.getElementById("academicYear").value.trim(),
                    "‡∏™‡∏≤‡∏Ç‡∏≤": document.getElementById("branch").value.trim(),
                    "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£": document.getElementById("applicationDate").value.trim(),
                    "‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°": document.getElementById("program").value.trim(),
                    "‡∏ã‡∏µ‡∏ã‡∏±‡πà‡∏ô": document.getElementById("season").value.trim(),
                    "‡∏£‡∏∞‡∏î‡∏±‡∏ö": document.getElementById("classLevel").value.trim(),
                    "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô": document.getElementById("promotion").value.trim(),
                    "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©": document.getElementById("discount").value.trim(),
                    "‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö": document.getElementById("paymentMethod").value.trim(),
                    "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏": document.getElementById("notes").value.trim(),
                    "‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°": document.getElementById("totalAmount").value.trim(),
                    "‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°": document.getElementById("fees").value.trim(),
                    "‡∏™‡∏∏‡∏ó‡∏ò‡∏¥": document.getElementById("netAmount").value.trim()
                };

                
                // Remove empty fields
                const filteredData = {};
               for (const key in salesRecordData) {
                if (salesRecordData[key]) {
                filteredData[key] = salesRecordData[key];
                }
                }
                // 3. Send all sales record data to Apps Script
                try {
                   fetch(GOOGLE_SHEET_SALES_WEB_APP_URL, {
                                method: 'POST',
                                mode: 'no-cors',
                headers: {
                         'Content-Type': 'application/x-www-form-urlencoded'
                         },


                        body: new URLSearchParams({
                        action: 'saveSalesRecord',
                        data: JSON.stringify(salesRecordData)       
                    })
                    });

                    if (result.success) {
                        displayMessage('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                        // Optionally, clear the form or reset state after successful save
                    } else {
                        displayMessage(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${result.error || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    console.error('Error saving sales record:', error);
                    displayMessage(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ: ${error.message}.`, 'error');
                }
            });

            // Initial fetches
            fetchCourseData(); // Fetch course data on load
document.getElementById("search-student-button").addEventListener("click", () => {
  const idCard = studentIdCardInput.value.trim();
  if (idCard) {
    Swal.fire({
      title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...',
      didOpen: () => {
        Swal.showLoading();
      },
      allowOutsideClick: false,
      allowEscapeKey: false
    });

    fetchStudentDetails("idCard", idCard).finally(() => {
      Swal.close();
    });
  } else {
    Swal.fire('‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô!', '', 'info');
  }
});

    </script>



</body>
</html>
