<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Records</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .card {
            background-color: #ffffff;
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            padding: 1.5rem; /* Standard padding for content cards */
        }
        .section-header {
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* font-bold */
            color: #1f2937; /* gray-900 */
            margin-bottom: 1rem;
            border-bottom: 2px solid #F89D2F; /* Orange accent line */
            padding-bottom: 0.5rem;
        }
        .detail-action-button {
            background-color: #F89D2F; /* Specific Orange for buttons */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* font-semibold */
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .detail-action-button:hover {
            background-color: #D28528; /* Darker orange on hover */
        }
        .detail-action-button.outline {
            background-color: transparent;
            color: #F89D2F;
            border: 1px solid #F89D2F;
            box-shadow: none;
        }
        .detail-action-button.outline:hover {
            background-color: #ffe7d6; /* Light orange on hover */
        }
        
        /* Form element styling */
        .form-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            font-size: 0.9rem;
            color: #374151; /* gray-700 */
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .form-field:focus {
            outline: none;
            border-color: #F89D2F; /* Orange border on focus */
            box-shadow: 0 0 0 3px rgba(248, 157, 47, 0.3); /* Orange ring on focus */
        }
        .form-label {
            display: block;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #4b5563; /* gray-600 */
            margin-bottom: 0.5rem;
        }

        /* Responsive grid for main sections */
        .sales-records-grid {
            display: grid;
            gap: 1.5rem; /* Gap between cards */
            grid-template-columns: repeat(1, minmax(0, 1fr)); /* Default to single column */
        }
        @media (min-width: 768px) { /* Medium screens */
            .sales-records-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr)); /* Two columns */
            }
        }
        @media (min-width: 1024px) { /* Large screens */
            .sales-records-grid {
                grid-template-columns: repeat(4, minmax(0, 1fr)); /* Four columns */
            }
        }
        /* Specific column spans for larger sections */
        .col-span-2 {
            grid-column: span 2 / span 2;
        }
        @media (min-width: 1024px) {
            .lg\:col-span-2 {
                grid-column: span 2 / span 2;
            }
            .lg\:col-span-1 {
                grid-column: span 1 / span 1;
            }
            .lg\:col-start-3 {
                grid-column-start: 3;
            }
            .lg\:row-start-1 {
                grid-row-start: 1;
            }
        }

        /* Course section specific styling */
        .course-table-container {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            overflow: auto; /* Changed from hidden to auto for scrollability */
            flex-grow: 1; /* Allow it to grow in flex container */
            display: flex;
            flex-direction: column; /* Organize content vertically */
        }
        .course-table-wrapper {
            flex-grow: 1;
            overflow-y: auto; /* Enable vertical scrolling within the table wrapper */
        }
        .course-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            text-align: left;
        }
        .course-table th, .course-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap; /* Prevent wrapping in table cells */
        }
        .course-table thead {
            background-color: #f9fafb;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            position: sticky; /* Make header sticky */
            top: 0; /* Stick to the top */
            z-index: 1; /* Ensure it stays above scrolling content */
        }
        .course-table tbody tr:last-child td {
            border-bottom: none;
        }
        .course-table tbody tr:hover {
            background-color: #f3f4f6;
        }

        /* Message Box for notifications */
        .message-box {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            color: white;
            z-index: 1000;
            display: none; /* Hidden by default */
        }
        .message-box.info { background-color: #3b82f6; } /* blue-500 */
        .message-box.success { background-color: #22c55e; } /* green-500 */
        .message-box.error { background-color: #ef4444; } /* red-500 */
    
@media print {
  .hidden { display: block !important; }
  body * {
    visibility: hidden !important;
  }
  #receipt-preview, #receipt-preview * {
    visibility: visible !important;
  }
  #receipt-preview {
    position: absolute !important;
    left: 0 !important;
    top: 0 !important;
    width: 100vw !important;
    min-height: 0 !important;
    height: auto !important;
    background: white !important;
    padding: 24px !important;
    box-sizing: border-box !important;
    display: block !important;
    overflow: visible !important;
  }
}



    
    </style>
</head>
<body class="p-8">

    <div class="container mx-auto">
        <div class="mb-6">
            <a href="Sales Administrator.html" class="detail-action-button outline">
                <i class="fas fa-arrow-left"></i> Back to Sales Administrator
            </a>
        </div>

        <h1 class="text-3xl font-bold text-gray-800 mb-8">Sales Records</h1>

        <div class="sales-records-grid">

            <!-- Section 1: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô -->
            <div class="card lg:col-span-1">
                <h2 class="section-header">1.‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                <div class="space-y-4">
                    <div>
                        <label for="student-id-card" class="form-label">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
                        <input type="text" id="idCard" class="form-field" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô">
                        <button id="search-student-button" class="detail-action-button mt-2">
                          üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                        </button>
                      </div>
                    <div>
                        <label for="student-code" class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                        <input type="text" id="studentCode" class="form-field" placeholder="">
                    </div>
                    <div>
                        <label for="student-name" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á</label>
                        <input type="text" id="firstName" class="form-field" placeholder="" readonly>
                    </div>
                    <div>
                        <label for="student-surname" class="form-label">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                        <input type="text" id="lastName" class="form-field" placeholder="" readonly>
                    </div>
                    <div>
                        <label for="student-nickname" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                        <input type="text" id="nickname" class="form-field" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
                        <button id="save-nickname-button" class="detail-action-button mt-2">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</button>
                    </div>
                </div>
            </div>

            <!-- Section 2: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£ -->
            <div class="card lg:col-span-1">
                <h2 class="section-header">2.‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h2>
                <div class="space-y-4">
                    <div>
                        <label for="studentStatus" class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                        <select id="studentStatus" class="form-field">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                            <option value="old">‡πÄ‡∏Å‡πà‡∏≤</option>
                            <option value="new">‡πÉ‡∏´‡∏°‡πà</option>
                        </select>
                    </div>
                    <div>
                        <label for="applicationType" class="form-label">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£</label>
                        <select id="applicationType" class="form-field">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£</option>
                            <option value="Line">Line</option>
                            <option value="Walk in">Walk in</option>
                        </select>
                    </div>
                    <div>
                        <label for="academicYear" class="form-label">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
                        <select id="academicYear" class="form-field">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
                            <option value="2567">2567</option>
                            <option value="2568">2568</option>
                            <option value="2569">2569</option>
                            <option value="2570">2570</option>
                        </select>
                    </div>
                    <div>
                        <label for="branch" class="form-label">‡∏™‡∏≤‡∏Ç‡∏≤</label>
                        <select id="branch" class="form-field">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
                            <option value="megabangna">‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏°‡∏Å‡∏≤‡∏ö‡∏≤‡∏á‡∏ô‡∏≤</option>
                            <option value="sukhapiban3">‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏• 3</option>
                            <option value="megabangna-off-account">‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏°‡∏Å‡∏≤‡∏ö‡∏≤‡∏á‡∏ô‡∏≤ (‡∏ô‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ)</option>
                            <option value="sukhapiban3-off-account">‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏• 3 (‡∏ô‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ)</option>
                        </select>
                    </div>
                    <div>
                        <label for="application-date" class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</label>
                        <input type="date" id="application-date" class="form-field">
                    </div>
                    <div>
                        <label for="program" class="form-label">‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°</label>
                        <select id="program" class="form-field">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°</option>
                            <option value="ALC">ALC</option>
                            <option value="TCH">TCH</option>
                        </select>
                    </div>
                    <div>
                        <label for="season" class="form-label">Season</label>
                        <select id="season" class="form-field">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Season</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ">‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ</option>
                        </select>
                    </div>
                    <div>
                        <label for="classLevel" class="form-label">‡∏£‡∏∞‡∏î‡∏±‡∏ö</label>
                        <select id="classLevel" class="form-field">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô</option>
                            <option value="p6">‡∏õ.6</option>
                            <option value="m3">‡∏°.3</option>
                            <option value="m4">‡∏°.4</option>
                            <option value="m5">‡∏°.5</option>
                            <option value="m6">‡∏°.6</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Section 3: ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£ -->
            


            <div class="card lg:col-span-2 lg:col-start-3 lg:row-start-1 flex flex-col">
                <h2 class="section-header">3.‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h2>
                <!-- Course selection and add area -->
                <div class="col-span-2 flex justify-end">
                    <button id="search-courses-button" type="button" class="btn btn-primary">
                        üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏≠‡∏ô
                    </button>
                </div>

                <div class="flex items-end gap-2 mb-4">
                    <div class="flex-grow">
                        <label for="course-select" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
                        <select id="course-select" class="form-field">
                        <option value="">--- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ ---</option> <!-- ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î default -->
                        </select>

                           
                  
                    </div>
                    

                    <button id="add-course-button" class="detail-action-button bg-green-500 hover:bg-green-600 px-4 py-2">
                        <i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°
                    </button>
                </div>
                
                <!-- Course table -->
                <div class="course-table-container">
                    <div class="course-table-wrapper">
                        <table class="course-table">
                            <thead>
                                <tr>
                                    <th>‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏≠‡∏£‡πå‡∏™</th>
                                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏™</th>
                                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th> <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° -->
                                    <th>‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                                    <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                                    <th>‡∏•‡∏ö</th>     
                                </tr>
                            </thead>
                            <tbody id="selectedCoursesTable">
                                <!-- Dynamically added courses will go here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Section 4: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ä‡∏≥‡∏£‡∏∞ -->
            <div class="card lg:col-span-1">
                <h2 class="section-header">4.‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ä‡∏≥‡∏£‡∏∞</h2>
                <div class="space-y-4">
                    <div>
                        <label for="promotion" class="form-label">‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô</label>
                        <input type="text" id="promotion" class="form-field" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô" readonly>
                    </div>
                    <div>
                        <label for="discount" class="form-label">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©</label>
                        <input type="text" id="discount" class="form-field" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î">
                    </div>
                    <div>
                        <label for="payment-method" class="form-label">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö</label>
                        <select id="payment-method" class="form-field">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞</option>
                            <option value="cash">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                            <option value="transfer">‡πÇ‡∏≠‡∏ô</option>
                            <option value="credit">‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</option>
                        </select>
                    </div>
                    <div>
                        <label for="notes" class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <textarea id="notes" rows="3" class="form-field" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"></textarea>
                    </div>
                </div>
            </div>

            <!-- Section 5: ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î -->
            <div class="card lg:col-span-1">
                <h2 class="section-header">5.‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</h2>
                <div class="space-y-4">
                    <div>
                        <label for="total-amount" class="form-label">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</label>
                        <input type="text" id="total-amount" class="form-field" readonly>
                    </div>
                    <div>
                        <label for="fees" class="form-label">‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏° (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï)</label>
                        <input type="text" id="fees" class="form-field" readonly>
                    </div>
                    <div>
                        <label for="net-amount" class="form-label">‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</label>
                        <input type="text" id="net-amount" class="form-field" readonly>
                    </div>
                </div>
            </div>
<!-- Section: ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô -->
<div class="card lg:col-span-2 lg:col-start-3 lg:row-start-2 flex flex-col">
  <h2 class="section-header" >üßæ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</h2>
  <div id="receipt-preview-preview" class="text-sm space-y text-gray-800 ">
    <!-- JavaScript ‡∏à‡∏∞‡∏°‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ -->
  </div>
</div>





            
            <!-- Save button (placed outside the grid for full width control) -->
           <div class="mt-4 col-span-full flex flex-col md:flex-row justify-center gap-4">
    <button id="save-button" class="detail-action-button bg-blue-600 hover:bg-blue-700 w-full md:w-auto px-8 py-3 rounded-xl shadow-lg">
        <i class="fas fa-save mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    </button>

    <button id="reset-form-button" class="detail-action-button bg-red-500 hover:bg-red-600 w-full md:w-auto px-8 py-3 rounded-xl shadow-lg">
        <i class="fas fa-trash-alt mr-2"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
    </button>

    <button id="preview-receipt-button" class="detail-action-button bg-gray-600 hover:bg-gray-700 w-full md:w-auto px-8 py-3 rounded-xl shadow-lg">
  üßæ ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
    </button>
</div>

        </div>
    </div>

    <!-- Receipt Print Area (for printing only) -->
    <div id="receipt-preview" class="print-area hidden">
      <!-- Will be filled by printReceipt() -->
    </div>
    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (outside grid, at bottom) -->
    <div class="flex justify-center mt-4">
      <button onclick="printReceipt()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 shadow-md">
  üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
</button>
    </div>



    <!-- Message box for notifications -->
    <div id="infoMessageBox" class="message-box"></div>
   
    <script>

        window.selectedCourses = [];
        
let lastRunningNumber = {
  '1A': 220,
  '2A': 17
};
const studentNameInput = document.getElementById('firstName');
const studentSurnameInput = document.getElementById('lastName');
const applicationDateInput = document.getElementById('application-date');
const branchInput = document.getElementById('branch');
const academicYearInput = document.getElementById('academicYear');
const notesInput = document.getElementById('notes');
const totalAmountInput = document.getElementById('total-amount');
const discountInput = document.getElementById('discount');
const feesInput = document.getElementById('fees');
const netAmountInput = document.getElementById('net-amount');
const paymentMethodInput = document.getElementById('payment-method');

        document.addEventListener('DOMContentLoaded', () => {

            const selectedCoursesTable = document.getElementById('selectedCoursesTable');
          
            const GOOGLE_SHEET_SALES_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxWtZcyQIUQNxexbxEYSrjjEb955nnhtuRiuWJ9MRb5RyH6lu_SDhddI7tiOJ2IXYGN/exec';

            // IMPORTANT: Replace with your deployed Google Apps Script Web App URL for COURSE DATA
            const GOOGLE_SHEET_COURSE_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwevCEa6J7akWRfLszvg9sz8Kv4ww_2-EP9E-n0dw2RWTJ6HWIJn6n6NvYqbeC5ElfLrg/exec';        

            const studentIdCardInput = document.getElementById('idCard');
            const studentCodeInput = document.getElementById('studentCode'); 
            const studentNameInput = document.getElementById('firstName');
            const studentSurnameInput = document.getElementById('lastName');
            const studentNicknameInput = document.getElementById('nickname');

            const studentStatusInput = document.getElementById('studentStatus');
            const applicationTypeInput = document.getElementById('applicationType');
            const academicYearInput = document.getElementById('academicYear');
            const branchInput = document.getElementById('branch');
            const applicationDateInput = document.getElementById('application-date');
            const programInput = document.getElementById('program');
            const seasonInput = document.getElementById('season'); // Corrected ID usage
            const classInput = document.getElementById('classLevel'); // Corrected ID usage

            const promotionInput = document.getElementById('promotion');
            const discountInput = document.getElementById('discount');
            const paymentMethodInput = document.getElementById('payment-method');
            const notesInput = document.getElementById('notes');

            const courseSelect = document.getElementById('course-select');
            const addCourseButton = document.getElementById('add-course-button');
            
            const totalAmountInput = document.getElementById('total-amount');
            const feesInput = document.getElementById('fees');
            const netAmountInput = document.getElementById('net-amount');
            const saveButton = document.getElementById('save-button');
            const infoMessageBox = document.getElementById('infoMessageBox');
            

            let availableCourses = []; // Stores all fetched course data
             // Stores courses currently added to the table
            let originalNickname = ''; // To track if nickname was changed from database

            
            // Initial fetches

 function renderSelectedCourses() {
  selectedCoursesTable.innerHTML = '';
  if (window.selectedCourses.length === 0) {
    const noDataRow = document.createElement('tr');
    noDataRow.innerHTML = `<td colspan="6" class="text-center text-gray-500 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td>`;
    selectedCoursesTable.appendChild(noDataRow);
    return;
  }

  window.selectedCourses.forEach((course, index) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${course.course_code}</td>
      <td>${course.course_name}</td>
      <td>${course.status || '-'}</td>
      <td>${course.price}</td>
      <td>${course.unit}</td>
      <td>
        <button class="remove-course-button bg-red-500 text-white px-2 py-1 rounded" data-index="${index}">‡∏•‡∏ö</button>
      </td>
    `;
    selectedCoursesTable.appendChild(tr);
  });
}


function calculateTotals() {
  const sum = window.selectedCourses.reduce((acc, course) => acc + course.price, 0);
  totalAmountInput.value = sum.toLocaleString();

  const promo = parseFloat(promotionInput.value.replace(/,/g, '')) || 0;
  const dis = parseFloat(discountInput.value.replace(/,/g, '')) || 0;

  let base = sum - promo - dis;
  let fee = 0;

  const paymentType = paymentMethodInput.value;
  if (paymentType === 'credit') {
    fee = base * 0.03;
  }

  const net = base + fee;

  feesInput.value = Math.round(fee).toLocaleString(); // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  netAmountInput.value = Math.round(net).toLocaleString();
}




            function applyPromotionDiscount() {
  const promoInput = document.getElementById('promotion');
  const courseCount = window.selectedCourses.length;
  let promoAmount = 0;

  if (courseCount === 2) promoAmount = 500;
  else if (courseCount === 3) promoAmount = 1000;
  else if (courseCount === 4) promoAmount = 1500;
  else if (courseCount >= 5) promoAmount = 2000;

  promoInput.value = promoAmount.toLocaleString(); // format 1,000
  calculateTotals(); // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÉ‡∏´‡∏°‡πà
}


            
          
async function fetchCourseData() {
  const year = academicYearInput.value.trim();
  const branch = branchInput.value.trim();
  const program = programInput.value.trim();
  const season = seasonInput.value.trim();
   const levelMap = {
  p6: "‡∏õ.6",
  m3: "‡∏°.3",
  m4: "‡∏°.4",
  m5: "‡∏°.5",
  m6: "‡∏°.6"
};
const level = levelMap[classInput.value.trim()] || '';

  const searchButton = document.getElementById('search-courses-button');

  // ‚úÖ 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö
  if (!year || !branch || !program || !season || !level) {
    Swal.fire({
      icon: 'warning',
      title: '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤',
      confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
    });
    return;
  }

  searchButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
searchButton.disabled = true;

  // ‚úÖ 2. ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤ "‡∏™‡∏≤‡∏Ç‡∏≤" ‡πÄ‡∏õ‡πá‡∏ô 1 ‡∏´‡∏£‡∏∑‡∏≠ 2
const branchMapped = branch === 'megabangna' || branch === 'megabangna-off-account' ? '1' :
                     branch === 'sukhapiban3' || branch === 'sukhapiban3-off-account' ? '2' : '';


  // ‚úÖ 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏à‡∏≤‡∏Å Web App
  const url = new URL(GOOGLE_SHEET_COURSE_WEB_APP_URL);
  url.searchParams.append("year", year);
  url.searchParams.append("branch", branchMapped);
  url.searchParams.append("program", program);
  url.searchParams.append("season", season);
  url.searchParams.append("level", level);

  // ‚úÖ 4. ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
    courseSelect.innerHTML = `<option disabled selected>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>`;
    courseSelect.disabled = true;

    Swal.fire({
  title: 'üìö ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
  allowOutsideClick: false,
  allowEscapeKey: false,
  didOpen: () => {
    Swal.showLoading();
  }
});


  try {
    const res = await fetch(url.toString());
    const data = await res.json();
    console.log('Fetched course data:', data);


    courseSelect.disabled = false;

    if (data && data.length > 0) {

        Swal.close();
      availableCourses = data.map(row => ({
  course_code: row['‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤'],
  course_name: row['‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏™'],
  price: parseFloat(row['‡∏£‡∏≤‡∏Ñ‡∏≤']) || 0,
  unit: '‡∏ö‡∏≤‡∏ó',
  status: row['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'],
  day: row['‡∏ß‡∏±‡∏ô'],       // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°
  time: row['‡πÄ‡∏ß‡∏•‡∏≤']      // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°
}));

      populateCourseDropdown(); // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
      
      Swal.fire('‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏û‡∏ö ${data.length} ‡∏ß‡∏¥‡∏ä‡∏≤`, 'success');
    } else {
      Swal.fire('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç', 'info');
    }
  } catch (error) {
    Swal.close();
    Swal.fire('‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', `‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`, 'error');

    } finally {
    // ‚úÖ ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°
    searchButton.innerHTML = 'üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏≠‡∏ô';
    searchButton.disabled = false;

  }
}


selectedCoursesTable.addEventListener('click', function(e) {
  if (e.target.classList.contains('remove-course-button')) {
    const index = parseInt(e.target.dataset.index);
    if (!isNaN(index)) {
      window.selectedCourses.splice(index, 1);
      renderSelectedCourses();
      applyPromotionDiscount();
    }
  }
});


function populateCourseDropdown() {
  courseSelect.innerHTML = '<option value="">--- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ ---</option>';
  availableCourses.forEach(course => {
    const option = document.createElement('option');
    option.value = course.course_code;
    option.textContent = `${course.course_code} | ${course.course_name} | ${course.day || ''} ${course.time || ''} | ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${course.status || ''} | ‡∏£‡∏≤‡∏Ñ‡∏≤: ${course.price || ''} ‡∏ö‡∏≤‡∏ó`;
    courseSelect.appendChild(option);
  });
}





            // Utility function to display messages
            function displayMessage(message, type = "info") {
                infoMessageBox.textContent = message;
                infoMessageBox.className = `message-box ${type}`; // Apply type class for styling
                infoMessageBox.style.display = 'block';

                setTimeout(() => {
                    infoMessageBox.style.display = 'none';
                }, 5000); // Hide after 5 seconds
            }

            document.getElementById('search-courses-button').addEventListener('click', fetchCourseData);


            document.getElementById("search-student-button").addEventListener("click", async () => {
  const idCard = studentIdCardInput.value.trim();
  if (!idCard) {
    Swal.fire('‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô!', '', 'info');
    return;
  }

 Swal.fire({
  title: 'üì° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...',
  text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
  allowOutsideClick: false,
  didOpen: () => Swal.showLoading()
});

await fetchStudentDetails("idCard", idCard);

});


            // Function to fetch student details from Google Apps Script
async function fetchStudentDetails(searchType, searchValue) {
  try {
    const url = new URL(GOOGLE_SHEET_SALES_WEB_APP_URL);
    url.searchParams.append(searchType, searchValue);
    const response = await fetch(url.toString());
    const data = await response.json();
    console.log('RAW ROWS:', data);

    Swal.close(); // üü¢ ‡∏õ‡∏¥‡∏î loading ‡πÄ‡∏™‡∏°‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•

    if (data && data['‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á']) {
      studentNameInput.value = data['‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á'] || '';
      studentCodeInput.value = data['‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'] || '';
      studentSurnameInput.value = data['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] || '';
      studentNicknameInput.value = data['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô'] || '';
      originalNickname = data['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô'] || '';
      studentNicknameInput.readOnly = false;

      Swal.fire('üéâ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success');
    } else {
      studentCodeInput.value = '';
      studentNameInput.value = '';
      studentSurnameInput.value = '';
      studentNicknameInput.value = '';
      studentNicknameInput.readOnly = false;

      Swal.fire('‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á', 'info');
    }
  } catch (error) {
    console.error('Error fetching student details:', error);
    Swal.close(); // üõë ‡∏õ‡∏¥‡∏î Loading ‡∏ï‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î error ‡∏î‡πâ‡∏ß‡∏¢
    Swal.fire('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
  }
    renderSelectedCourses();  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
    applyPromotionDiscount(); // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà

}




            // Function to save/update student nickname
   async function saveStudentNickname(idType, idValue, nickname) {
  if (!idValue || !nickname) {
    displayMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™ ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'error');
    return;
  }

try {
  const formData = new URLSearchParams();
  formData.append(idType, idValue);
  formData.append('nickname', nickname);
  formData.append('action', 'updateNickname');


  Swal.fire({
  title: 'üíæ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô...',
  allowOutsideClick: false,
  didOpen: () => {
    Swal.showLoading();
  }
});


  await fetch(GOOGLE_SHEET_SALES_WEB_APP_URL, {
    method: 'POST',
    mode: 'no-cors',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: formData.toString()
  });
  
  Swal.close();
  Swal.fire({
    icon: 'success',
    title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
    timer: 1500,
    showConfirmButton: false
  });

} catch (error) {
  console.error(error);
  Swal.fire({
    icon: 'error',
    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
    text: error.message
  });
}
}



            // Event listener for ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô input
            let typingTimer; // Timer identifier
            const doneTypingInterval = 500; // Time in ms (0.5 second)

            // Event listener for ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô input
           

                // ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏¢‡∏Å
                
document.getElementById("save-nickname-button").addEventListener("click", async () => {

  
  Swal.fire({
    title: 'üíæ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...',
    didOpen: () => {
      Swal.showLoading();
    },
    allowOutsideClick: false,
    allowEscapeKey: false
  });
const idCard = studentIdCardInput.value.trim();
  const studentCode = studentCodeInput.value.trim();
  const nickname = studentNicknameInput.value.trim();
  const idType = idCard ? 'idCard' : 'studentCode';
  const idValue = idCard || studentCode;
   if (!idValue || !nickname) {
    Swal.fire('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', '', 'warning');
    return;
  }

  await saveStudentNickname(idType, idValue, nickname);
  Swal.close();
});
 



addCourseButton.addEventListener('click', () => {
    const selectedCourseCode = courseSelect.value;
    if (!selectedCourseCode) {
        displayMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°', 'info');
        return;
    }

    const courseToAdd = availableCourses.find(course => course.course_code === selectedCourseCode);

    if (courseToAdd && !window.selectedCourses.some(c => c.course_code === courseToAdd.course_code)) {
    window.selectedCourses.push(courseToAdd);
    renderSelectedCourses();
    applyPromotionDiscount();
    calculateTotals();
}
 else if (window.selectedCourses.some(c => c.course_code === courseToAdd.course_code)) {
        displayMessage('‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß', 'info');
    }
});

document.addEventListener('click', function(e) {
  if (e.target.closest('.remove-course-button')) {
    const courseCode = e.target.closest('.remove-course-button').dataset.courseCode;
    window.selectedCourses = window.selectedCourses.filter(course => course.course_code !== courseCode);
    renderSelectedCourses();
    applyPromotionDiscount();
    calculateTotals();
  }
});

discountInput.addEventListener('input', calculateTotals);
promotionInput.addEventListener('input', calculateTotals);
paymentMethodInput.addEventListener('change', calculateTotals);




// ‚úÖ ‡∏õ‡∏∏‡πà‡∏° reset form
document.getElementById('reset-form-button').addEventListener('click', async () => {
  const confirm = await Swal.fire({
    title: '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
    text: "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
  });

  if (confirm.isConfirmed) {
    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°
    studentIdCardInput.value = '';
    studentCodeInput.value = '';
    studentNameInput.value = '';
    studentSurnameInput.value = '';
    studentNicknameInput.value = '';
    originalNickname = '';

    studentStatusInput.value = '';
    applicationTypeInput.value = '';
    academicYearInput.value = '';
    branchInput.value = '';
    applicationDateInput.value = '';
    programInput.value = '';
    seasonInput.value = '';
    classInput.value = '';

    promotionInput.value = '0';
    discountInput.value = '';
    paymentMethodInput.value = '';
    notesInput.value = '';
    totalAmountInput.value = '';
    feesInput.value = '';
    netAmountInput.value = '';

    window.selectedCourses = [];
    availableCourses = [];
    courseSelect.innerHTML = `<option value="">--- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ ---</option>`;

    renderSelectedCourses();
    applyPromotionDiscount();

    Swal.fire('üßπ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '', 'success');
  }
});

document.getElementById('preview-receipt-button').addEventListener('click', () => {
  const receiptDiv = document.getElementById('receipt-preview-preview');
  const receiptNumber = generateReceiptNumber(branchInput.value.trim(), academicYearInput.value.trim());
  const studentInfo = `
    <div><strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à:</strong> ${receiptNumber}</div>
    <div><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${applicationDateInput.value}</div>
    <div><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${studentNameInput.value} ${studentSurnameInput.value}</div>
    <div><strong>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô:</strong> ${studentNicknameInput.value}</div>
    <div><strong>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</strong> ${studentCodeInput.value}</div>
    <div><strong>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£:</strong> ${studentIdCardInput.value}</div>
  `;

  const courseList = window.selectedCourses.map(c => `
    <tr>
      <td class="border px-2 py-1">${c.course_code}</td>
      <td class="border px-2 py-1">${c.course_name}</td>
      <td class="border px-2 py-1 text-right">${c.price.toLocaleString()} ‡∏ö‡∏≤‡∏ó</td>
    </tr>
  `).join('');

  const courseTable = `
    <table class="w-full text-left text-sm border-collapse mt-4">
      <thead>
        <tr class="bg-gray-100">
          <th class="border px-2 py-1">‡∏£‡∏´‡∏±‡∏™</th>
          <th class="border px-2 py-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤</th>
          <th class="border px-2 py-1 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
        </tr>
      </thead>
      <tbody>${courseList}</tbody>
    </table>
  `;

  const summary = `
    <div class="mt-4 border-t pt-4">
      <div><strong>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</strong> ${totalAmountInput.value} ‡∏ö‡∏≤‡∏ó</div>
      <div><strong>‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô:</strong> ${promotionInput.value} ‡∏ö‡∏≤‡∏ó</div>
      <div><strong>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©:</strong> ${discountInput.value} ‡∏ö‡∏≤‡∏ó</div>
      <div><strong>‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°:</strong> ${feesInput.value} ‡∏ö‡∏≤‡∏ó</div>
      <div class="text-lg font-bold"><strong>‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</strong> ${netAmountInput.value} ‡∏ö‡∏≤‡∏ó</div>
    </div>
  `;

  receiptDiv.innerHTML = `${studentInfo}${courseTable}${summary}`;
  receiptDiv.scrollIntoView({ behavior: 'smooth' });
});


           });

      function generateReceiptNumber(branch, year) {
  const branchPrefix =  branch === 'megabangna' || branch === 'megabangna-off-account' ? '1A' :
                        branch === 'sukhapiban3' || branch === 'sukhapiban3-off-account' ? '2A' : '';
  const yearSuffix = year.slice(-2); // ‡πÄ‡∏ä‡πà‡∏ô "2568" ‚Üí "68"
  const run = lastRunningNumber[branchPrefix]++;
  const runStr = run.toString().padStart(4, '0');
  return `${branchPrefix}${yearSuffix}${runStr}`;
}




function printReceipt() {
  // Get the receipt preview div
const receiptDiv = document.getElementById('receipt-preview');
const logoUrl = "https://drive.google.com/uc?export=view&id=1vqOEp9DqFNqw0kp89u4ziznZuuaGDuy9";
 
const receiptNumber = typeof generateReceiptNumber === 'function'
    ? generateReceiptNumber(branchInput.value.trim(), academicYearInput.value.trim())
    : '-';
  // Build the receipt content
  const studentName = document.getElementById('firstName').value + ' ' + document.getElementById('lastName').value;
  const studentCode = document.getElementById('studentCode').value;
  const idCard = document.getElementById('idCard').value;
  const nickname = document.getElementById('nickname').value;
  const applicationDate = document.getElementById('application-date').value;

  // Build course list
 const courseRows = window.selectedCourses.map((c, i) => `
    <tr>
      <td style="border:1px solid #222; padding:6px; text-align:center;">${i+1}</td>
      <td style="border:1px solid #222; padding:6px;">${c.course_code}</td>
      <td style="border:1px solid #222; padding:6px;">${c.course_name}</td>
      <td style="border:1px solid #222; padding:6px; text-align:right;">${c.price.toLocaleString()} ‡∏ö‡∏≤‡∏ó</td>
    </tr>
  `).join('');

  receiptDiv.innerHTML = `
    <div style="width:700px; margin:0 auto; font-family:Arial,sans-serif; color:#222;">
      <div style="display:flex; align-items:flex-start;">
        <img src="${logoUrl}" style="height:60px; margin-right:16px;">
        <div style="flex:1;">
          <div style="font-weight:bold; font-size:18px;">‡∏≠‡∏±‡∏•‡∏ü‡πà‡∏≤ ‡∏ï‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</div>
          <div>‡∏™‡∏≤‡∏Ç‡∏≤ ‡πÄ‡∏°‡∏Å‡∏≤‡∏ö‡∏≤‡∏á‡∏ô‡∏≤</div>
          <div>30/98 ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡∏£‡∏∏‡∏á‡∏Ø...</div>
          <div>alphatofschool@gmail.com</div>
          <div>02-125-3183</div>
        </div>
      </div>
      <div style="text-align:center; margin:24px 0 8px 0;">
        <div style="font-size:22px; font-weight:bold;">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</div>
        <div style="font-size:14px;">RECEIPT</div>
      </div>
      <table style="width:100%; border:1px solid #222; border-collapse:collapse; margin-bottom:8px;">
        <tr>
          <td style="border:1px solid #222; padding:6px; width:50%;">
            ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤<br><span style="font-size:12px;">CUSTOMER</span>
          </td>
          <td style="border:1px solid #222; padding:6px; width:25%;">
            ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à<br><span style="font-size:12px;">RECEIPT NO.</span>
          </td>
          <td style="border:1px solid #222; padding:6px; width:25%;">
            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà<br><span style="font-size:12px;">DATE</span>
          </td>
        </tr>
        <tr>
          <td style="border:1px solid #222; padding:6px;">
            ${studentNameInput.value} ${studentSurnameInput.value}
          </td>
          <td style="border:1px solid #222; padding:6px;">
            ${receiptNumber}
          </td>
          <td style="border:1px solid #222; padding:6px;">
            ${applicationDateInput.value}
          </td>
        </tr>
      </table>
      <table style="width:100%; border:1px solid #222; border-collapse:collapse; margin-bottom:8px;">
        <thead>
          <tr>
            <th style="border:1px solid #222; padding:6px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö<br><span style="font-size:12px;">NO</span></th>
            <th style="border:1px solid #222; padding:6px;">‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤<br><span style="font-size:12px;">CODE</span></th>
            <th style="border:1px solid #222; padding:6px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î<br><span style="font-size:12px;">DESCRIPTION</span></th>
            <th style="border:1px solid #222; padding:6px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (THB)<br><span style="font-size:12px;">AMOUNT</span></th>
          </tr>
        </thead>
        <tbody>
          ${courseRows}
        </tbody>
      </table>
      <div style="display:flex; justify-content:space-between; margin-top:16px;">
        <div>
          <div>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô AMOUNT: <b>${totalAmountInput.value} ‡∏ö‡∏≤‡∏ó</b></div>
          <div style="margin-top:8px;">
            <input type="checkbox" ${paymentMethodInput.value === "transfer" ? "checked" : ""}> ‡πÇ‡∏≠‡∏ô TRANSFER
            <input type="checkbox" ${paymentMethodInput.value === "credit" ? "checked" : ""} style="margin-left:16px;"> ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï CREDIT CARD
          </div>
        </div>
        <table style="border:1px solid #222; border-collapse:collapse; min-width:200px;">
          <tr><td style="border:1px solid #222; padding:6px;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°<br>SUB TOTAL</td><td style="border:1px solid #222; padding:6px; text-align:right;">${totalAmountInput.value} ‡∏ö‡∏≤‡∏ó</td></tr>
          <tr><td style="border:1px solid #222; padding:6px;">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î<br>DISCOUNT</td><td style="border:1px solid #222; padding:6px; text-align:right;">${discountInput.value} ‡∏ö‡∏≤‡∏ó</td></tr>
          <tr><td style="border:1px solid #222; padding:6px;">‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°<br>FEE</td><td style="border:1px solid #222; padding:6px; text-align:right;">${feesInput.value} ‡∏ö‡∏≤‡∏ó</td></tr>
          <tr><td style="border:1px solid #222; padding:6px;">‡∏™‡∏∏‡∏ó‡∏ò‡∏¥<br>NET TOTAL</td><td style="border:1px solid #222; padding:6px; text-align:right;">${netAmountInput.value} ‡∏ö‡∏≤‡∏ó</td></tr>
        </table>
      </div>
      <div style="margin-top:24px;">
        ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏<br>
        <div style="border:1px solid #222; min-height:40px; padding:6px;">${notesInput.value}</div>
      </div>
      <div style="display:flex; justify-content:flex-end; margin-top:32px;">
        <div style="text-align:center;">
          <div>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô<br>COLLECTOR</div>
          <div style="height:40px;"></div>
          <div>__________________________</div>
        </div>
        <div style="width:32px;"></div>
        <div style="text-align:center;">
          <div>AUTHORIZED BY</div>
          <div style="height:40px;"></div>
          <div>__________________________</div>
        </div>
      </div>
    </div>
  `;
  receiptDiv.classList.remove('hidden');
  window.print();
  setTimeout(() => receiptDiv.classList.add('hidden'), 1000);
}
            // Save button functionality
            saveButton.addEventListener('click', async () => {
                const idCard = studentIdCardInput.value.trim();
                const studentCode = studentCodeInput.value.trim(); 
                const currentNickname = studentNicknameInput.value.trim();

                let idType = '';
                let idValue = '';

                if (idCard) {
                    idType = 'idCard';
                    idValue = idCard;
                } else if (studentCode) {
                    idType = 'studentCode';
                    idValue = studentCode;
                }

                // 1. Save/Update Nickname
                if (idValue && currentNickname !== originalNickname) {
                    await saveStudentNickname(idType, idValue, currentNickname);
                } else if (!idValue) {
                    displayMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'error');
                }

                // 2. Gather all sales record data
                const salesRecordData = {
                    "‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô": document.getElementById("idCard").value.trim(),
                    "‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô": document.getElementById("studentCode").value.trim(),
                    "‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á": document.getElementById("firstName").value.trim(),
                    "‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•": document.getElementById("lastName").value.trim(),
                    "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô": document.getElementById("nickname").value.trim(),
                    "‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô": document.getElementById("school").value.trim(),
                    "Email": document.getElementById("email").value.trim(),
                    "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà": document.getElementById("address").value.trim(),

                    "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô": document.getElementById("studentStatus").value.trim(),
                    "‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£": document.getElementById("applicationType").value.trim(),
                    "‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤": document.getElementById("academicYear").value.trim(),
                    "‡∏™‡∏≤‡∏Ç‡∏≤": document.getElementById("branch").value.trim(),
                    "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£": document.getElementById("applicationDate").value.trim(),
                    "‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°": document.getElementById("program").value.trim(),
                    "‡∏ã‡∏µ‡∏ã‡∏±‡πà‡∏ô": document.getElementById("season").value.trim(),
                    "‡∏£‡∏∞‡∏î‡∏±‡∏ö": document.getElementById("classLevel").value.trim(),
                    "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô": document.getElementById("promotion").value.trim(),
                    "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©": document.getElementById("discount").value.trim(),
                    "‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö": document.getElementById("paymentMethod").value.trim(),
                    "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏": document.getElementById("notes").value.trim(),
                    "‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°": document.getElementById("totalAmount").value.trim(),
                    "‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°": document.getElementById("fees").value.trim(),
                    "‡∏™‡∏∏‡∏ó‡∏ò‡∏¥": document.getElementById("netAmount").value.trim()
                };


// ‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô save-button click


const receiptHTML = `
  <div><strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à:</strong> ${receiptNumber}</div>
  <div><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${salesRecordData["‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á"]} ${salesRecordData["‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"]}</div>
  <div><strong>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô:</strong> ${salesRecordData["‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô"]}</div>
  <div><strong>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</strong> ${salesRecordData["‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"]}</div>
  <div><strong>‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£:</strong></div>
  <ul class="list-disc pl-5">
    ${window.selectedCourses.map(c => `<li>${c.course_name} (${c.course_code}) - ${c.price.toLocaleString()} ‡∏ö‡∏≤‡∏ó</li>`).join('')}
  </ul>
  <div><strong>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</strong> ${totalAmountInput.value} ‡∏ö‡∏≤‡∏ó</div>
  <div><strong>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</strong> ${discountInput.value || '0'} ‡∏ö‡∏≤‡∏ó</div>
  <div><strong>‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô:</strong> ${promotionInput.value || '0'} ‡∏ö‡∏≤‡∏ó</div>
  <div><strong>‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°:</strong> ${feesInput.value || '0'} ‡∏ö‡∏≤‡∏ó</div>
  <div><strong>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</strong> ${netAmountInput.value} ‡∏ö‡∏≤‡∏ó</div>
`;

document.getElementById('receipt-preview-preview').innerHTML = receiptHTML;
document.getElementById('receipt-preview-preview').classList.remove('hidden');



                
                // Remove empty fields
                const filteredData = {};
               for (const key in salesRecordData) {
                if (salesRecordData[key]) {
                filteredData[key] = salesRecordData[key];
                }
                }
                // 3. Send all sales record data to Apps Script
                try {
                   fetch(GOOGLE_SHEET_SALES_WEB_APP_URL, {
                                method: 'POST',
                                mode: 'no-cors',
                headers: {
                         'Content-Type': 'application/x-www-form-urlencoded'
                         },


                        body: new URLSearchParams({
                        action: 'saveSalesRecord',
                        data: JSON.stringify(salesRecordData)       
                    })
                    });

                    if (result.success) {
                        displayMessage('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                        window.selectedCourses = [];
                        renderSelectedCourses();
                        applyPromotionDiscount();

                        // Optionally, clear the form or reset state after successful save
                    } else {
                        displayMessage(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${result.error || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    console.error('Error saving sales record:', error);
                    displayMessage(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ: ${error.message}.`, 'error');
                }
            });

            
document.getElementById('print-receipt-button').addEventListener('click', () => {
  const receiptDiv = document.getElementById('receipt-preview');

  const studentInfo = `
    <div><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${applicationDateInput.value}</div>
    <div><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${studentNameInput.value} ${studentSurnameInput.value}</div>
    <div><strong>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô:</strong> ${studentNicknameInput.value}</div>
    <div><strong>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</strong> ${studentCodeInput.value}</div>
    <div><strong>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£:</strong> ${studentIdCardInput.value}</div>
  `;

  const courseList = (window.selectedCourses || []).map(c => `
    <tr>
      <td class="border px-2 py-1">${c.course_code}</td>
      <td class="border px-2 py-1">${c.course_name}</td>
      <td class="border px-2 py-1 text-right">${c.price.toLocaleString()} ‡∏ö‡∏≤‡∏ó</td>
    </tr>
  `).join('');

  const courseTable = `
    <table class="w-full text-left text-sm border-collapse mt-4">
      <thead>
        <tr class="bg-gray-100">
          <th class="border px-2 py-1">‡∏£‡∏´‡∏±‡∏™</th>
          <th class="border px-2 py-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤</th>
          <th class="border px-2 py-1 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
        </tr>
      </thead>
      <tbody>${courseList}</tbody>
    </table>
  `;

  const summary = `
    <div class="mt-4 border-t pt-4">
      <div><strong>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</strong> ${totalAmountInput.value} ‡∏ö‡∏≤‡∏ó</div>
      <div><strong>‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô:</strong> ${promotionInput.value} ‡∏ö‡∏≤‡∏ó</div>
      <div><strong>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©:</strong> ${discountInput.value} ‡∏ö‡∏≤‡∏ó</div>
      <div><strong>‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°:</strong> ${feesInput.value} ‡∏ö‡∏≤‡∏ó</div>
      <div class="text-lg font-bold"><strong>‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</strong> ${netAmountInput.value} ‡∏ö‡∏≤‡∏ó</div>
    </div>
  `;

  receiptDiv.innerHTML = `${studentInfo}${courseTable}${summary}`;
  receiptDiv.classList.remove('hidden');
  window.print();
  setTimeout(() => receiptDiv.classList.add('hidden'), 1000);
});


</script>



</body>
</html>
